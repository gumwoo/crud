<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="biz.lunch.mapper.LunchMapper">

    <!-- ============================================ -->
    <!-- 점심비 등록 (마스터 + 참여자 한 번에) -->
    <!-- ============================================ -->
    <insert id="registerLunch" parameterType="map" useGeneratedKeys="true" keyProperty="lunchId">
        <!-- 1. 마스터 등록 -->
        WITH master_insert AS (
            INSERT INTO tb_lunch_master (
                lunch_date,
                store_name,
                lunch_type,
                payer_user_id,
                payer_user_name,
                total_amount,
                settlement_status,
                description,
                register_user_id,
                register_date
            ) VALUES (
                #{lunchDate},
                #{storeName},
                CASE 
                    WHEN #{storeName} LIKE '%커피%' OR #{storeName} LIKE '%카페%' 
                        OR #{storeName} LIKE '%스타벅스%' OR #{storeName} LIKE '%이디야%'
                    THEN 'COFFEE'
                    ELSE 'LUNCH'
                END,
                #{payerUserId},
                #{payerUserName},
                #{totalAmount},
                'PENDING',
                #{description},
                #{registerUserId, jdbcType=VARCHAR},
                CURRENT_TIMESTAMP
            )
            RETURNING lunch_id
        )
        -- 2. 참여자 등록 (JSON 배열을 행으로 변환)
        INSERT INTO tb_lunch_participant (
            lunch_id,
            user_id,
            user_name,
            amount,
            register_date
        )
        SELECT 
            m.lunch_id,
            p->>'userId' as user_id,
            p->>'userName' as user_name,
            (p->>'amount')::integer as amount,
            CURRENT_TIMESTAMP
        FROM master_insert m
        CROSS JOIN json_array_elements(#{participants}::json) AS p
    </insert>

    <!-- ============================================ -->
    <!-- 점심비 수정 (마스터 + 참여자 한 번에) -->
    <!-- ============================================ -->
    <update id="updateLunch" parameterType="map">
        -- 1. 기존 참여자 삭제
        DELETE FROM tb_lunch_participant WHERE lunch_id = #{lunchId};
        
        -- 2. 마스터 수정
        UPDATE tb_lunch_master SET
            lunch_date = #{lunchDate},
            store_name = #{storeName},
            lunch_type = CASE 
                WHEN #{storeName} LIKE '%커피%' OR #{storeName} LIKE '%카페%' 
                    OR #{storeName} LIKE '%스타벅스%' OR #{storeName} LIKE '%이디야%'
                THEN 'COFFEE'
                ELSE 'LUNCH'
            END,
            total_amount = #{totalAmount},
            description = #{description},
            update_user_id = #{updateUserId},
            update_date = CURRENT_TIMESTAMP
        WHERE lunch_id = #{lunchId};
        
        -- 3. 참여자 재등록
        INSERT INTO tb_lunch_participant (
            lunch_id,
            user_id,
            user_name,
            amount,
            register_date
        )
        SELECT 
            #{lunchId},
            p->>'userId' as user_id,
            p->>'userName' as user_name,
            (p->>'amount')::integer as amount,
            CURRENT_TIMESTAMP
        FROM json_array_elements(#{participants}::json) AS p
    </update>

    <!-- ============================================ -->
    <!-- 점심비 삭제 (마스터 삭제 시 참여자 자동 삭제) -->
    <!-- ============================================ -->
    <delete id="deleteLunch" parameterType="int">
        DELETE FROM tb_lunch_master
        WHERE lunch_id = #{lunchId}
    </delete>

    <!-- ============================================ -->
    <!-- 점심비 목록 조회 (Map 반환) -->
    <!-- ============================================ -->
    <select id="getLunchList" parameterType="map" resultType="map">
        SELECT 
            m.lunch_id as "lunchId",
            m.lunch_date as "lunchDate",
            m.store_name as "storeName",
            m.lunch_type as "lunchType",
            m.payer_user_id as "payerUserId",
            m.payer_user_name as "payerUserName",
            m.total_amount as "totalAmount",
            m.settlement_status as "settlementStatus",
            m.settlement_date as "settlementDate",
            m.description as "description",
            -- 참여자 JSON 배열로 집계
            COALESCE(
                json_agg(
                    json_build_object(
                        'participantId', p.participant_id,
                        'userId', p.user_id,
                        'userName', p.user_name,
                        'amount', p.amount
                    )
                    ORDER BY p.participant_id
                ) FILTER (WHERE p.participant_id IS NOT NULL),
                '[]'::json
            ) as "participants"
        FROM tb_lunch_master m
        LEFT JOIN tb_lunch_participant p ON m.lunch_id = p.lunch_id
        WHERE 1=1
        <if test="startDate != null and startDate != ''">
            AND m.lunch_date >= #{startDate}::date
        </if>
        <if test="endDate != null and endDate != ''">
            AND m.lunch_date <![CDATA[<=]]> #{endDate}::date
        </if>
        <if test="userId != null and userId != ''">
            AND (m.payer_user_id = #{userId} OR p.user_id = #{userId})
        </if>
        <if test="settlementStatus != null and settlementStatus != ''">
            AND m.settlement_status = #{settlementStatus}
        </if>
        GROUP BY m.lunch_id, m.lunch_date, m.store_name, m.lunch_type,
                 m.payer_user_id, m.payer_user_name, m.total_amount,
                 m.settlement_status, m.settlement_date, m.description
        ORDER BY m.lunch_date DESC, m.lunch_id DESC
    </select>

    <!-- ============================================ -->
    <!-- 통계 조회 (Map 반환) -->
    <!-- ============================================ -->
    <select id="getStatistics" resultType="map">
        SELECT 
            COUNT(*) as "totalCount",
            COALESCE(SUM(total_amount), 0) as "totalAmount",
            COALESCE(AVG(total_amount), 0) as "avgAmount",
            COUNT(CASE WHEN lunch_type = 'LUNCH' THEN 1 END) as "lunchCount",
            COUNT(CASE WHEN lunch_type = 'COFFEE' THEN 1 END) as "coffeeCount",
            COUNT(CASE WHEN settlement_status = 'PENDING' THEN 1 END) as "pendingCount",
            COUNT(CASE WHEN settlement_status = 'COMPLETED' THEN 1 END) as "completedCount"
        FROM tb_lunch_master
        WHERE lunch_date >= DATE_TRUNC('month', CURRENT_DATE)
          AND lunch_date < DATE_TRUNC('month', CURRENT_DATE) + INTERVAL '1 month'
    </select>

    <!-- ============================================ -->
    <!-- 정산 완료 처리 -->
    <!-- ============================================ -->
    <update id="completeSettlement" parameterType="map">
        UPDATE tb_lunch_master SET
            settlement_status = 'COMPLETED',
            settlement_date = CURRENT_DATE,
            update_user_id = #{updateUserId},
            update_date = CURRENT_TIMESTAMP
        WHERE 1=1
        <if test="lunchId != null">
            AND lunch_id = #{lunchId}
        </if>
        <if test="startDate != null and startDate != ''">
            AND lunch_date >= #{startDate}::date
        </if>
        <if test="endDate != null and endDate != ''">
            AND lunch_date <![CDATA[<=]]> #{endDate}::date
        </if>
        AND settlement_status = 'PENDING'
    </update>

</mapper>
