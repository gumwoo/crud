<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="biz.lunch.dao.LunchMapper">

    <!-- ============================================ -->
    <!-- Result Map 정의 -->
    <!-- ============================================ -->
    
    <!-- 마스터 기본 ResultMap -->
    <resultMap id="lunchMasterMap" type="biz.lunch.vo.LunchMasterVO">
        <id property="lunchId" column="lunch_id"/>
        <result property="lunchDate" column="lunch_date"/>
        <result property="storeName" column="store_name"/>
        <result property="lunchType" column="lunch_type"/>
        <result property="payerUserId" column="payer_user_id"/>
        <result property="payerUserName" column="payer_user_name"/>
        <result property="totalAmount" column="total_amount"/>
        <result property="settlementStatus" column="settlement_status"/>
        <result property="settlementDate" column="settlement_date"/>
        <result property="description" column="description"/>
        <result property="registerUserId" column="register_user_id"/>
        <result property="registerDate" column="register_date"/>
        <result property="updateUserId" column="update_user_id"/>
        <result property="updateDate" column="update_date"/>
    </resultMap>
    
    <!-- 참여자 ResultMap -->
    <resultMap id="participantMap" type="biz.lunch.vo.LunchParticipantVO">
        <id property="participantId" column="participant_id"/>
        <result property="lunchId" column="lunch_id"/>
        <result property="userId" column="user_id"/>
        <result property="userName" column="user_name"/>
        <result property="amount" column="amount"/>
        <result property="registerDate" column="register_date"/>
    </resultMap>
    
    <!-- 마스터 + 참여자 ResultMap (Collection) -->
    <resultMap id="lunchMasterWithParticipants" type="biz.lunch.vo.LunchMasterVO" extends="lunchMasterMap">
        <collection property="participants" ofType="biz.lunch.vo.LunchParticipantVO">
            <id property="participantId" column="participant_id"/>
            <result property="lunchId" column="lunch_id"/>
            <result property="userId" column="user_id"/>
            <result property="userName" column="user_name"/>
            <result property="amount" column="amount"/>
        </collection>
    </resultMap>
    
    <!-- 참여자 + 마스터 정보 ResultMap (집계용) -->
    <resultMap id="participantWithMasterMap" type="biz.lunch.vo.LunchParticipantVO" extends="participantMap">
        <!-- 추가 필드는 VO에 없지만 서비스에서 사용하므로 매핑 제외 -->
        <!-- m.payer_user_id, m.total_amount, m.lunch_date는 서비스 로직에서 직접 처리 -->
    </resultMap>

    <!-- ============================================ -->
    <!-- 마스터 CRUD -->
    <!-- ============================================ -->
    
    <!-- 점심/커피 내역 등록 -->
    <insert id="insertLunchMaster" parameterType="biz.lunch.vo.LunchMasterVO" useGeneratedKeys="true" keyProperty="lunchId">
        INSERT INTO tb_lunch_master (
            lunch_date,
            store_name,
            lunch_type,
            payer_user_id,
            payer_user_name,
            total_amount,
            settlement_status,
            description,
            register_user_id,
            register_date
        ) VALUES (
            #{lunchDate},
            #{storeName},
            #{lunchType},
            #{payerUserId},
            #{payerUserName},
            #{totalAmount},
            COALESCE(#{settlementStatus}, '대기'),
            #{description},
            #{registerUserId},
            CURRENT_TIMESTAMP
        )
    </insert>
    
    <!-- 점심/커피 내역 수정 -->
    <update id="updateLunchMaster" parameterType="biz.lunch.vo.LunchMasterVO">
        UPDATE tb_lunch_master
        SET lunch_date = #{lunchDate},
            store_name = #{storeName},
            lunch_type = #{lunchType},
            payer_user_id = #{payerUserId},
            payer_user_name = #{payerUserName},
            total_amount = #{totalAmount},
            description = #{description},
            update_user_id = #{updateUserId},
            update_date = CURRENT_TIMESTAMP
        WHERE lunch_id = #{lunchId}
    </update>
    
    <!-- 점심/커피 내역 삭제 -->
    <delete id="deleteLunchMaster" parameterType="int">
        DELETE FROM tb_lunch_master
        WHERE lunch_id = #{lunchId}
    </delete>
    
    <!-- 점심/커피 내역 상세 조회 -->
    <select id="selectLunchMaster" parameterType="int" resultMap="lunchMasterMap">
        SELECT 
            lunch_id,
            lunch_date,
            store_name,
            lunch_type,
            payer_user_id,
            payer_user_name,
            total_amount,
            settlement_status,
            settlement_date,
            description,
            register_user_id,
            register_date,
            update_user_id,
            update_date
        FROM tb_lunch_master
        WHERE lunch_id = #{lunchId}
    </select>

    <!-- 참여자 CRUD -->

    
    <!-- 참여자 등록 -->
    <insert id="insertParticipant" parameterType="biz.lunch.vo.LunchParticipantVO" useGeneratedKeys="true" keyProperty="participantId">
        INSERT INTO tb_lunch_participant (
            lunch_id,
            user_id,
            user_name,
            amount,
            register_date
        ) VALUES (
            #{lunchId},
            #{userId},
            #{userName},
            #{amount},
            CURRENT_TIMESTAMP
        )
    </insert>
    
    <!-- 참여자 수정 -->
    <update id="updateParticipant" parameterType="biz.lunch.vo.LunchParticipantVO">
        UPDATE tb_lunch_participant
        SET user_id = #{userId},
            user_name = #{userName},
            amount = #{amount}
        WHERE participant_id = #{participantId}
    </update>
    
    <!-- 특정 내역의 참여자 전체 삭제 -->
    <delete id="deleteParticipantsByLunchId" parameterType="int">
        DELETE FROM tb_lunch_participant
        WHERE lunch_id = #{lunchId}
    </delete>
    
    <!-- 특정 내역의 참여자 목록 조회 -->
    <select id="selectParticipantsByLunchId" parameterType="int" resultMap="participantMap">
        SELECT 
            participant_id,
            lunch_id,
            user_id,
            user_name,
            amount,
            register_date
        FROM tb_lunch_participant
        WHERE lunch_id = #{lunchId}
        ORDER BY user_id
    </select>

    <!-- 조회 및 집계 -->

    
    <!-- 점심/커피 내역 목록 조회 (조건별) -->
    <select id="selectLunchList" parameterType="map" resultMap="lunchMasterMap">
        SELECT 
            m.lunch_id,
            m.lunch_date,
            m.store_name,
            m.lunch_type,
            m.payer_user_id,
            m.payer_user_name,
            m.total_amount,
            m.settlement_status,
            m.settlement_date,
            m.description,
            m.register_user_id,
            m.register_date
        FROM tb_lunch_master m
        WHERE 1=1
        <if test="startDate != null and startDate != ''">
            AND m.lunch_date >= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''">
            AND m.lunch_date <![CDATA[<=]]> #{endDate}
        </if>
        <if test="storeName != null and storeName != ''">
            AND m.store_name LIKE CONCAT('%', #{storeName}, '%')
        </if>
        <if test="lunchType != null and lunchType != ''">
            AND m.lunch_type = #{lunchType}
        </if>
        <if test="settlementStatus != null and settlementStatus != ''">
            AND m.settlement_status = #{settlementStatus}
        </if>
        <if test="payerUserId != null and payerUserId != ''">
            AND m.payer_user_id = #{payerUserId}
        </if>
        ORDER BY m.lunch_date DESC, m.lunch_id DESC
    </select>
    
    <!-- 점심/커피 내역 목록 조회 (참여자 정보 포함) -->
    <select id="selectLunchListWithParticipants" parameterType="map" resultMap="lunchMasterWithParticipants">
        SELECT 
            m.lunch_id,
            m.lunch_date,
            m.store_name,
            m.lunch_type,
            m.payer_user_id,
            m.payer_user_name,
            m.total_amount,
            m.settlement_status,
            m.settlement_date,
            p.participant_id,
            p.user_id,
            p.user_name,
            p.amount
        FROM tb_lunch_master m
        LEFT JOIN tb_lunch_participant p ON m.lunch_id = p.lunch_id
        WHERE 1=1
        <if test="startDate != null and startDate != ''">
            AND m.lunch_date >= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''">
            AND m.lunch_date <![CDATA[<=]]> #{endDate}
        </if>
        <if test="userId != null and userId != ''">
            AND p.user_id = #{userId}
        </if>
        <if test="settlementStatus != null and settlementStatus != ''">
            AND m.settlement_status = #{settlementStatus}
        </if>
        ORDER BY m.lunch_date DESC, m.lunch_id DESC, p.user_id
    </select>
    
    <!-- 기간별 참여자 목록 조회 (집계용) -->
    <select id="selectParticipantsForSummary" parameterType="map" resultMap="participantMap">
        SELECT 
            p.participant_id,
            p.lunch_id,
            p.user_id,
            p.user_name,
            p.amount,
            m.payer_user_id,
            m.total_amount,
            m.lunch_date
        FROM tb_lunch_participant p
        INNER JOIN tb_lunch_master m ON p.lunch_id = m.lunch_id
        WHERE 1=1
        <if test="startDate != null and startDate != ''">
            AND m.lunch_date >= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''">
            AND m.lunch_date <![CDATA[<=]]> #{endDate}
        </if>
        <if test="settlementStatus != null and settlementStatus != ''">
            AND m.settlement_status = #{settlementStatus}
        </if>
        ORDER BY m.lunch_date, p.user_id
    </select>
    
    <!-- 사용자별 참여 횟수 조회 -->
    <select id="selectUserParticipationCount" parameterType="map" resultType="map">
        SELECT 
            p.user_id,
            p.user_name,
            COUNT(DISTINCT m.lunch_id) as participation_count,
            SUM(p.amount) as total_amount
        FROM tb_lunch_participant p
        INNER JOIN tb_lunch_master m ON p.lunch_id = m.lunch_id
        WHERE 1=1
        <if test="startDate != null and startDate != ''">
            AND m.lunch_date >= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''">
            AND m.lunch_date <![CDATA[<=]]> #{endDate}
        </if>
        <if test="settlementStatus != null and settlementStatus != ''">
            AND m.settlement_status = #{settlementStatus}
        </if>
        GROUP BY p.user_id, p.user_name
        ORDER BY p.user_id
    </select>
    
    <!-- 결제자별 결제 횟수 조회 -->
    <select id="selectPayerCount" parameterType="map" resultType="map">
        SELECT 
            payer_user_id,
            payer_user_name,
            COUNT(*) as payer_count,
            SUM(total_amount) as total_paid
        FROM tb_lunch_master
        WHERE 1=1
        <if test="startDate != null and startDate != ''">
            AND lunch_date >= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''">
            AND lunch_date <![CDATA[<=]]> #{endDate}
        </if>
        <if test="settlementStatus != null and settlementStatus != ''">
            AND settlement_status = #{settlementStatus}
        </if>
        GROUP BY payer_user_id, payer_user_name
        ORDER BY payer_count DESC
    </select>


    <!-- 정산 처리 -->

    
    <!-- 정산 완료 처리 -->
    <update id="updateSettlementStatus" parameterType="map">
        UPDATE tb_lunch_master
        SET settlement_status = '완료',
            settlement_date = CURRENT_TIMESTAMP,
            update_user_id = #{updateUserId},
            update_date = CURRENT_TIMESTAMP
        WHERE lunch_id = #{lunchId}
    </update>
    
    <!-- 정산 완료 취소 -->
    <update id="cancelSettlement" parameterType="map">
        UPDATE tb_lunch_master
        SET settlement_status = '대기',
            settlement_date = NULL,
            update_user_id = #{updateUserId},
            update_date = CURRENT_TIMESTAMP
        WHERE lunch_id = #{lunchId}
    </update>

    <!-- 통계 -->

    
    <!-- 월별 통계 조회 -->
    <select id="selectMonthlyStatistics" parameterType="map" resultType="map">
        SELECT 
            TO_CHAR(lunch_date, 'YYYY-MM') as month,
            COUNT(*) as total_count,
            SUM(total_amount) as total_amount,
            SUM(CASE WHEN store_name LIKE '%커피%' THEN 1 ELSE 0 END) as coffee_count,
            SUM(CASE WHEN store_name NOT LIKE '%커피%' THEN 1 ELSE 0 END) as lunch_count,
            SUM(CASE WHEN store_name LIKE '%커피%' THEN total_amount ELSE 0 END) as coffee_amount,
            SUM(CASE WHEN store_name NOT LIKE '%커피%' THEN total_amount ELSE 0 END) as lunch_amount,
            SUM(CASE WHEN settlement_status = '완료' THEN 1 ELSE 0 END) as settled_count,
            SUM(CASE WHEN settlement_status = '대기' THEN 1 ELSE 0 END) as pending_count
        FROM tb_lunch_master
        WHERE 1=1
        <if test="year != null and year != ''">
            AND EXTRACT(YEAR FROM lunch_date) = #{year}
        </if>
        <if test="month != null and month != ''">
            AND EXTRACT(MONTH FROM lunch_date) = #{month}
        </if>
        GROUP BY TO_CHAR(lunch_date, 'YYYY-MM')
        ORDER BY month DESC
    </select>
    
    <!-- 사용자별 통계 조회 -->
    <select id="selectUserStatistics" parameterType="map" resultType="map">
        SELECT 
            p.user_id,
            p.user_name,
            COUNT(DISTINCT m.lunch_id) as participation_count,
            SUM(p.amount) as total_amount,
            SUM(CASE WHEN m.lunch_type = '점심' THEN 1 ELSE 0 END) as lunch_count,
            SUM(CASE WHEN m.lunch_type = '커피' THEN 1 ELSE 0 END) as coffee_count
        FROM tb_lunch_participant p
        INNER JOIN tb_lunch_master m ON p.lunch_id = m.lunch_id
        WHERE 1=1
        <if test="startDate != null and startDate != ''">
            AND m.lunch_date >= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''">
            AND m.lunch_date <![CDATA[<=]]> #{endDate}
        </if>
        <if test="userId != null and userId != ''">
            AND p.user_id = #{userId}
        </if>
        GROUP BY p.user_id, p.user_name
        ORDER BY total_amount DESC
    </select>

</mapper>
